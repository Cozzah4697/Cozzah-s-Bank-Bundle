@name ui_security
@persist Elements:table
@inputs [EGP EGPRaid]:wirelink User:entity

#include "CozzahsBankBundle/includes/functions"

if (first()) {
    # Initialize variables
    Elements = table()
    EGPRaid:egpDrawTopLeft(1)
}

function number table:get(...Args:array) {
    const Name = Args[1, string]
    if (Name) {
        if (This:exists(Name)) {
            return This[Name, number]   
        }
        const FreeID = This:flip():ncount()+1
        This[Name, number] = FreeID
        return FreeID
    }
    const FreeID = This:flip():ncount()+1
    This[toString(FreeID), number] = FreeID
    return FreeID
}

function void wirelink:clear() {
    This:egpClear()
    Elements:clear()
}


function egpobject text(EGP:wirelink, ID:number, ARGS:table) {
    return EGP:egpTextLayout(ID, ARGS)
}

function egpobject circle(EGP:wirelink, ID:number, ARGS:table) {
    if (ARGS["outline", number]) {
        return EGP:egpCircleOutline(ID, ARGS)
    }
    return EGP:egpCircle(ID, ARGS)
}

function egpobject box(EGP:wirelink, ID:number, ARGS:table) {
    if (ARGS["outline", number]) {
        return EGP:egpRoundedBoxOutline(ID, ARGS)
    }
    return EGP:egpRoundedBox(ID, ARGS)
}

function egpobject line(EGP:wirelink, ID:number, ARGS:table) {
    return EGP:egpBox(ID, ARGS)
}

function void removeOffscreenObjects(EGP:wirelink, Elements:table) {
    # Get the screen dimensions (using standard EGP dimensions)
    const ScreenWidth = 512
    const ScreenHeight = 512
    const Buffer = 300 # Extra buffer distance to ensure objects are well off-screen
    
    # Loop through all elements in the Elements table
    foreach(Name:string, ID:number = Elements) {
        if (ID) { # Make sure the element exists
            const Pos = EGP:egpPos(ID)
            const Size = EGP:egpSize(ID)
            
            # Check if element is completely off screen (with buffer)
            if (Pos:x() < -Size:x() - Buffer || 
                Pos:x() > ScreenWidth + Buffer || 
                Pos:y() < -Size:y() - Buffer || 
                Pos:y() > ScreenHeight + Buffer) {
                
                # Element is off-screen, remove it
                EGP:egpRemove(ID)
                Elements:remove(Name) # Also remove from Elements table
                print("Removed off-screen element: " + Name)
            }
        }
    }
} 

function string cursorObj(Names:array) {
    const Cursor = EGP:egpCursor(User)
    # Iterate through objects
    for (I = 1, Names:count()) {
        const ID = Elements:get(Names[I, string])
        const Object = EGP:egpobject(ID)
        if (Object:containsPoint(Cursor)) {
            return Names[I, string]
        }
    }

    return ""
}

function number userInput(Player:entity) { # Check for specific player input
    return ~User && Player:isValid()
}

function void guardScreen(EGP:wirelink, Salary:number, Guards:table) {
    EGP:egpClear()
    EGP:egpDrawTopLeft(1)

    #Background Section
    box(EGP, Elements:get("Rectangle234"), table("x"=0.0, "y"=0.0, "w"=512.0, "h"=512.0, "r"=89, "g"=89, "b"=89, "radius"=0))
    box(EGP, Elements:get("Rectangle235"), table("x"=67.0, "y"=0.0, "w"=379.0, "h"=512.0, "r"=42, "g"=42, "b"=42, "radius"=0))
    box(EGP, Elements:get("Rectangle236"), table("x"=67.0, "y"=0.0, "w"=379.0, "h"=61.0, "r"=55, "g"=55, "b"=55, "radius"=0))
    box(EGP, Elements:get("Rectangle237"), table("x"=67.0, "y"=59.0, "w"=379.0, "h"=4.0, "r"=0, "g"=0, "b"=0, "radius"=0))
    text(EGP, Elements:get("COZZAHSBANKG"), table("text"=owner():name():upper() + " BANK GUARDS", "x"=67.0, "y"=0.0, "w"= 379.0, "h"=59.0, "r"=255, "g"=255, "b"=255, "size"=27, "halign"=1, "valign"=1))

    #Apply Section
    box(EGP, Elements:get("Rectangle238"), table("x"=0.0, "y"=288.0, "w"=512.0, "h"=224.0, "r"=42, "g"=42, "b"=42, "radius"=0))
    text(EGP, Elements:get("SALARY"), table("text"="SALARY:", "x"=87.0, "y"=315.0, "w"= 169.0, "h"=35.0, "r"=255, "g"=255, "b"=255, "size"=27, "halign"=2, "valign"=1))
    text(EGP, Elements:get("APPLYTOBEAG"), table("text"="APPLY TO BE A GUARD AT " + owner():name():upper() + " BANK", "x"=0.0, "y"=288.0, "w"= 512.0, "h"=33.0, "r"=255, "g"=255, "b"=255, "size"=19, "halign"=1, "valign"=1))
    text(EGP, Elements:get("$1.5MIL/H"), table("text"= formatNumber(Salary/6) + "/10Min", "x"=256.0, "y"=315.0, "w"= 172.0, "h"=35.0, "r"=30, "g"=178, "b"=0, "size"=27, "halign"=0, "valign"=1))
    text(EGP, Elements:get("SECUREPRINTING"), table("text"="SECURE PRINTING AT 0% TAX", "x"=0.0, "y"=350.0, "w"= 512.0, "h"=35.0, "r"=255, "g"=255, "b"=255, "size"=27, "halign"=1, "valign"=1))
    box(EGP, Elements:get("ApplyButton"), table("x"=131.0, "y"=410.0, "w"=250.0, "h"=80.0, "r"=217, "g"=217, "b"=217, "radius"=50.0))
    box(EGP, Elements:get("Rectangle240"), table("x"=136.0, "y"=415.0, "w"=240.0, "h"=70.0, "r"=42, "g"=42, "b"=42, "radius"=50.0))
    box(EGP, Elements:get("1" + "Rectangle238"), table("x"=0.0, "y"=286.0, "w"=512.0, "h"=4.0, "r"=0, "g"=0, "b"=0, "radius"=0))
    text(EGP, Elements:get("APPLYNOW"), table("text"="APPLY NOW", "x"=131.0, "y"=410.0, "w"= 250.0, "h"=80.0, "r"=255, "g"=255, "b"=255, "size"=27, "halign"=1, "valign"=1))

    #Guards Section
    SteamIDs = Guards:keys()
    GuardSlots = array("GUARD1", "GUARD2", "GUARD3", "GUARD4")
    GuardYPositions = array(69.0, 126.0, 183.0, 240.0)
    
    for(I = 1, 4) {
        local GuardName = "EMPTY"  # Default to EMPTY
        local IsEmpty = 1  # Track if slot is empty
        
        # If we have a guard in this slot, get their actual name
        if(I <= SteamIDs:count()) {
            local GuardSteamID = SteamIDs[I, string]
            local FoundPlayer = 0
            
            # Use findPlayerBySteamID to locate the player
            local PlayerEntity = findPlayerBySteamID(GuardSteamID)
            if(PlayerEntity:isValid()) {
                GuardName = PlayerEntity:name():upper()
                IsEmpty = 0
                FoundPlayer = 1
            }
            
            # If player not found online, show offline status
            if(!FoundPlayer) {
                GuardName = "OFFLINE: " + GuardSteamID:sub(1, 8) + "..."
                IsEmpty = 0  # Still show as occupied since they're in the table
            }
        }
        
        # Set colors based on slot status
        local R = IsEmpty ? 255 : 255  # White for empty, Gold R for occupied
        local G = IsEmpty ? 255 : 215  # White for empty, Gold G for occupied
        local B = IsEmpty ? 255 : 0    # White for empty, Gold B for occupied
        
        # Display the guard slot
        text(EGP, Elements:get(GuardSlots[I, string]), table(
            "text" = GuardName,
            "x" = 67.0,
            "y" = GuardYPositions[I, number],
            "w" = 379.0,
            "h" = 39.0,
            "r" = R,
            "g" = G,
            "b" = B,
            "size" = 27,
            "halign" = 1,
            "valign" = 1
        ))
    }

    #diamondICO Section
    box(EGP, Elements:get("Rectangle67"), table("x"=23.52, "y"=408.42, "w"=81.33, "h"=64.86, "r"=185, "g"=242, "b"=255, "radius"=0))
    box(EGP, Elements:get("Rectangle68"), table("x"=22.48, "y"=425.52, "w"=83.42, "h"=2.71, "r"=42, "g"=42, "b"=42, "radius"=0))
    box(EGP, Elements:get("Rectangle69"), table("x"=101.6, "y"=403.04, "w"=21.11, "h"=9.48, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle69"), vec2(101.6, 403.04), vec2(0, 0), -57.0)
    box(EGP, Elements:get("Rectangle70"), table("x"=15.43, "y"=420.96, "w"=21.42, "h"=9.48, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle70"), vec2(15.43, 420.96), vec2(0, 0), 57.0)
    box(EGP, Elements:get("Rectangle71"), table("x"=34.19, "y"=408.71, "w"=2.71, "h"=23.22, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle71"), vec2(34.19, 408.71), vec2(0, 0), 37.0)
    box(EGP, Elements:get("Rectangle72"), table("x"=92.34, "y"=407.17, "w"=2.71, "h"=23.22, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle72"), vec2(92.34, 407.17), vec2(0, 0), -37.0)
    box(EGP, Elements:get("Rectangle74"), table("x"=62.52, "y"=406.75, "w"=2.71, "h"=23.22, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle74"), vec2(62.52, 406.75), vec2(0, 0), -37.0)
    box(EGP, Elements:get("Rectangle75"), table("x"=77.34, "y"=426.99, "w"=2.71, "h"=49.26, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle75"), vec2(77.34, 426.99), vec2(0, 0), -16.0)
    box(EGP, Elements:get("Rectangle77"), table("x"=107.17, "y"=424.93, "w"=29.5, "h"=64.95, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle77"), vec2(107.17, 424.93), vec2(0, 0), -40.0)
    box(EGP, Elements:get("Rectangle78"), table("x"=0.0, "y"=446.19, "w"=29.88, "h"=64.95, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle78"), vec2(0.0, 446.19), vec2(0, 0), 40.0)
    box(EGP, Elements:get("Rectangle76"), table("x"=48.13, "y"=427.94, "w"=2.71, "h"=49.26, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle76"), vec2(48.13, 427.94), vec2(0, 0), 16.0)
    box(EGP, Elements:get("Rectangle73"), table("x"=63.56, "y"=408.8, "w"=2.71, "h"=23.22, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle73"), vec2(63.56, 408.8), vec2(0, 0), 37.0)

    #GoldICO Section
    box(EGP, Elements:get("Rectangle60"), table("x"=411.88, "y"=436.8, "w"=70.66, "h"=20.18, "r"=255, "g"=215, "b"=0, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle60"), vec2(411.88, 436.8), vec2(0, 0), 29.0)
    box(EGP, Elements:get("Rectangle62"), table("x"=409.42, "y"=437.47, "w"=39.08, "h"=21.92, "r"=255, "g"=215, "b"=0, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle62"), vec2(409.42, 437.47), vec2(0, 0), -29.0)
    box(EGP, Elements:get("Rectangle64"), table("x"=424.36, "y"=455.83, "w"=69.1, "h"=22.75, "r"=255, "g"=215, "b"=0, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle64"), vec2(424.36, 455.83), vec2(0, 0), 30.0)
    box(EGP, Elements:get("Rectangle65"), table("x"=412.28, "y"=433.88, "w"=28.19, "h"=3.71, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle65"), vec2(412.28, 433.88), vec2(0, 0), -115.0)
    box(EGP, Elements:get("Rectangle61"), table("x"=409.36, "y"=434.84, "w"=28.19, "h"=3.71, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle61"), vec2(409.36, 434.84), vec2(0, 0), -27.0)
    box(EGP, Elements:get("Rectangle63"), table("x"=432.49, "y"=448.34, "w"=3.43, "h"=29.0, "r"=42, "g"=42, "b"=42, "radius"=0))
    box(EGP, Elements:get("Rectangle66"), table("x"=464.95, "y"=395.0, "w"=28.19, "h"=16.38, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("Rectangle66"), vec2(464.95, 395.0), vec2(0, 0), -22.0)
    box(EGP, Elements:get("1" + "Rectangle65"), table("x"=433.19, "y"=447.83, "w"=60.38, "h"=3.72, "r"=42, "g"=42, "b"=42, "radius"=0))
    EGP:egpAngle(Elements:get("1" + "Rectangle65"), vec2(433.19, 447.83), vec2(0, 0), 29.0)

}

