# Cozzah's Bank - Bank Configuration
# This file contains all tier definitions shared across all bank E2
@persist [TIER_COPPER TIER_SILVER TIER_GOLD TIER_DIAMOND TIER_RUBY]:number
@persist [BankName]:string

function string limitBankNameLength(Name:string, MaxLength:number) {
    if(Name:length() <= MaxLength) {
        return Name
    }
    
    return Name:sub(1, MaxLength - 3) + "..."
}

if(first() || dupefinished()) {
    #DEFAULT = 'owner():name() + "'S BANK"' will show as e.g "COZZAH'S BANK" 
    BankName = (owner():name() + "'S BANK")
    
    BankName = (limitBankNameLength(BankName,10)):upper()
    # Initialize tier constants
    TIER_COPPER = 0
    TIER_SILVER = 1
    TIER_GOLD = 2
    TIER_DIAMOND = 3
    TIER_RUBY = 4
}

# Returns the complete tier configuration table
function table getTierConfig() {
    local Config = table()
    
    # Copper Tier (Default/Free)
    Config[TIER_COPPER, table] = table(
        "name" = "Copper",
        "color_hex" = "#5D2D24",
        "color_r" = 184,
        "color_g" = 115,
        "color_b" = 51,
        "tax" = 0.35,          # 35% tax
        "cost" = 0,            # Free
        "insurance" = 0        # No insurance
    )
    
    # Silver Tier
    Config[TIER_SILVER, table] = table(
        "name" = "Silver",
        "color_hex" = "#C0C0C0",
        "color_r" = 192,
        "color_g" = 192,
        "color_b" = 192,
        "tax" = 0.25,          # 25% tax
        "cost" = 1000000,      # $1M
        "insurance" = 0.50   # %50 insurance
    )
    
    # Gold Tier
    Config[TIER_GOLD, table] = table(
        "name" = "Gold",
        "color_hex" = "#E6C300",
        "color_r" = 255,
        "color_g" = 215,
        "color_b" = 0,
        "tax" = 0.20,          # 20% tax
        "cost" = 2000000,      # $2M
        "insurance" = 0.75  # %75 insurance
    )
    
    # Diamond Tier
    Config[TIER_DIAMOND, table] = table(
        "name" = "Diamond",
        "color_hex" = "#00D0FF",
        "color_r" = 185,
        "color_g" = 242,
        "color_b" = 255,
        "tax" = 0.10,          # 10% tax
        "cost" = 5000000,      # $5M
        "insurance" = 1.0  # %100 insurance
    )
    
    # Ruby Tier
    Config[TIER_RUBY, table] = table(
        "name" = "Ruby",
        "color_hex" = "#9B111E",
        "color_r" = 155,
        "color_g" = 17,
        "color_b" = 30,
        "tax" = 0.01,          # 1% tax
        "cost" = 0,            # Free
        "insurance" = 1.0      # %100 insurance
    )
    
    return Config
}

# Helper function to get tier name
function string getTierName(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["name", string]
    }
    return "Copper"
}

# Helper function to get tier color (hex)
function string getTierColor(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_hex", string]
    }
    return "#5D2D24"
}

# Helper function to get tier color RGB values as vector
function vector getTierColorRGB(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        local TierData = Config[Tier, table]
        return vec(
            TierData["color_r", number],
            TierData["color_g", number],
            TierData["color_b", number]
        )
    }
    return vec(184, 115, 51)
}

# Helper function to get individual RGB components
function number getTierColorR(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_r", number]
    }
    return 184
}

function number getTierColorG(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_g", number]
    }
    return 115
}

function number getTierColorB(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_b", number]
    }
    return 51
}

# Helper function to get tier tax rate
function number getTierTax(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["tax", number]
    }
    return 0.15
}

# Helper function to get tier cost
function number getTierCost(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["cost", number]
    }
    return 0
}

# Helper function to get tier insurance amount
function number getTierInsurance(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["insurance", number]
    }
    return 0
}

# Function to get a player's membership tier
function number getMemberDataTier(Player:entity, MemberData:table) {
    if(!Player:isValid()) { return 0 }
    
    let SteamID = Player:steamID()
    
    # If they have no membership, return 0
    if(!MemberData:exists(SteamID)) {
        return 0
    }
    
    # Convert the string value to a number before returning
    return MemberData[SteamID, number]
}

# Helper function to get tax for a specific player (considering guards)
function number getTax(Player:entity, MemberData:table) {
    if(!Player:isValid()) { return 0.35 }
    
    local PlayerTier = getMemberDataTier(Player, MemberData)
    return getTierTax(PlayerTier)
}
