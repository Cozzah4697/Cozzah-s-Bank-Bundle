# Cozzah's Bank - Bank Configuration
# This file contains all tier definitions shared across all bank E2
@persist [TIER_COPPER TIER_SILVER TIER_GOLD TIER_DIAMOND TIER_RUBY]:number
@persist [BankName]:string

function string limitBankNameLength(Name:string, MaxLength:number) {
    if(Name:length() <= MaxLength) {
        return Name
    }
    
    return Name:sub(1, MaxLength - 3) + "..."
}

if(first() || dupefinished()) {
    #DEFAULT = 'owner():name() + "'S BANK"' will show as e.g "COZZAH'S BANK" 
    BankName = (owner():name() + "'S BANK")
    
    BankName = (limitBankNameLength(BankName,13)):upper()
    # Initialize tier constants
    TIER_COPPER = 0
    TIER_SILVER = 1
    TIER_GOLD = 2
    TIER_DIAMOND = 3
    TIER_RUBY = 4
}

# Returns the complete tier configuration table
function table getTierConfig() {
    local Config = table()
    
    # Copper Tier (Default/Free)
    Config[TIER_COPPER, table] = table(
        "name" = "Copper",
        "color_hex" = "#5D2D24",
        "color_r" = 184,
        "color_g" = 115,
        "color_b" = 51,
        "tax" = 0.35,          # 35% tax
        "cost" = 0,            # Free
        "insurance" = 0        # No insurance
    )
    
    # Silver Tier
    Config[TIER_SILVER, table] = table(
        "name" = "Silver",
        "color_hex" = "#C0C0C0",
        "color_r" = 192,
        "color_g" = 192,
        "color_b" = 192,
        "tax" = 0.25,          # 25% tax
        "cost" = 1000000,      # $1M
        "insurance" = 0.50     # %50 insurance
    )
    
    # Gold Tier
    Config[TIER_GOLD, table] = table(
        "name" = "Gold",
        "color_hex" = "#E6C300",
        "color_r" = 255,
        "color_g" = 215,
        "color_b" = 0,
        "tax" = 0.20,          # 20% tax
        "cost" = 2000000,      # $2M
        "insurance" = 0.75     # %75 insurance
    )
    
    # Diamond Tier
    Config[TIER_DIAMOND, table] = table(
        "name" = "Diamond",
        "color_hex" = "#00D0FF",
        "color_r" = 185,
        "color_g" = 242,
        "color_b" = 255,
        "tax" = 0.10,          # 10% tax
        "cost" = 5000000,      # $5M
        "insurance" = 1.0      # %100 insurance
    )
    
    # Ruby Tier
    Config[TIER_RUBY, table] = table(
        "name" = "Ruby",
        "color_hex" = "#9B111E",
        "color_r" = 155,
        "color_g" = 17,
        "color_b" = 30,
        "tax" = 0.0,          # 1% tax
        "cost" = 0,            # Free
        "insurance" = 1.0      # %100 insurance
    )
    
    return Config
}

# Helper function to get tier name
function string getTierName(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["name", string]
    }
    return "Copper"
}

# Helper function to get tier color (hex)
function string getTierColor(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_hex", string]
    }
    return "#5D2D24"
}

# Helper function to get individual RGB components
function number getTierColorR(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_r", number]
    }
    return 184
}

function number getTierColorG(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_g", number]
    }
    return 115
}

function number getTierColorB(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["color_b", number]
    }
    return 51
}

# Helper function to get tier tax rate
function number getTierTax(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["tax", number]
    }
    return 0.15
}

# Helper function to get tier cost (permanent membership)
function number getTierCost(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["cost", number]
    }
    return 0
}

# Helper function to get temp tier cost (half price of permanent)
function number getTierCostTemp(Tier:number) {
    return getTierCost(Tier) / 2
}

# Helper function to get tier insurance amount
function number getTierInsurance(Tier:number) {
    local Config = getTierConfig()
    if(Config:exists(Tier)) {
        return Config[Tier, table]["insurance", number]
    }
    return 0
}

# Function to get a player's effective membership tier (higher of perm or temp)
function number getEffectiveTier(Player:entity, MemberData:table) {
    if(!Player:isValid()) { return 0 }
    
    local SteamID = Player:steamID()
    
    # If they have no membership entry at all, return 0
    if(!MemberData:exists(SteamID)) {
        return 0
    }
    
    # Try to get as number first (old format)
    local OldTier = MemberData[SteamID, number]
    if(OldTier > 0) {
        return OldTier  # Legacy support
    }
    
    # New format (table with perm and temp)
    local Entry = MemberData[SteamID, table]
    local PermTier = Entry["perm_tier", number]
    local TempTier = Entry["temp_tier", number]
    
    return max(PermTier, TempTier)
}

# Function to get a player's permanent tier only
function number getPermTier(Player:entity, MemberData:table) {
    if(!Player:isValid()) { return 0 }
    
    local SteamID = Player:steamID()
    
    if(!MemberData:exists(SteamID)) {
        return 0
    }
    
    # Try as number first (old format)
    local OldTier = MemberData[SteamID, number]
    if(OldTier > 0) {
        return OldTier
    }
    
    # Otherwise use new format
    local Entry = MemberData[SteamID, table]
    return Entry["perm_tier", number]
}

# Function to get a player's temp tier only
function number getTempTier(Player:entity, MemberData:table) {
    if(!Player:isValid()) { return 0 }
    
    local SteamID = Player:steamID()
    
    if(!MemberData:exists(SteamID)) {
        return 0
    }
    
    # Try as number first (old format has no temp tier)
    local OldTier = MemberData[SteamID, number]
    if(OldTier > 0) {
        return 0  # Old format has no temp tiers
    }
    
    # Use new format
    local Entry = MemberData[SteamID, table]
    return Entry["temp_tier", number]
}

# Legacy function maintained for backwards compatibility - now uses effective tier
function number getMemberDataTier(Player:entity, MemberData:table) {
    return getEffectiveTier(Player, MemberData)
}

# Helper function to get tax for a specific player (considering guards)
function number getTax(Player:entity, MemberData:table) {
    if(!Player:isValid()) { return 0.35 }
    
    local PlayerTier = getEffectiveTier(Player, MemberData)
    return getTierTax(PlayerTier)
}
