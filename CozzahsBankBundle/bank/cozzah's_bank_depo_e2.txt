@name Cozzah's Banker E2 Depo

@inputs [Door]:wirelink

@persist [CurrentPlayer]:entity [Active]:number [MemberData]:table

#include "CozzahsBankBundle/includes/animations"
#include "CozzahsBankBundle/includes/ui"
#include "CozzahsBankBundle/includes/functions"
#include "CozzahsBankBundle/includes/membership_configuration"

function void sendReq() {
    broadcastRemoteEvent(table())
}

function void screenReset() {
    stopAllTimers()
    if(!timerExists("getTable")) { timer("getTable",60,0,function() { sendReq() }) }
    CurrentPlayer = _NO_ENTITY 
    Door["Fade", number] = 0
    Door:entity():soundPlay(0,2,"czero/doorstop6.wav")
    bankHomeScreen(Elements, EGP,"default",function() {
        depoMain(Elements, EGP)
    })
} 

if(first() || dupefinished() || ~EGP) {
    CurrentPlayer = _NO_ENTITY
    MemberData = table()
    Door["Fade", number] = 0
    bankHomeScreen(Elements, EGP,"default",function() {
        depoMain(Elements, EGP)
    })
    
    sendReq()
    timer("getTable",60,0,function() { sendReq() })
}



if(userInput(User) && (User == CurrentPlayer || CurrentPlayer == _NO_ENTITY)) {
    CurrentPlayer = User
    distanceFromEntity(CurrentPlayer, EGP:entity(), 250, function() {
        screenReset()
        Active = 0
    })
    
    let Cursor = cursorObj(array("Ellipse22", "ButtonDepo", "ExitButton", "InstructionsExitButton"))
    switch (Cursor) {
        case "Ellipse22",
            if(!Active) {
                Active = 1
                EGP:entity():soundPlay(0,2,"buttons/lever3.wav")
                timer(10,function() { removeOffscreenObjects(Elements, EGP) })
                rotateTo("Ellipse22",2,180)
                timer(3.3,function() { moveTo(Elements,"MADEWITHODIN",1,vec2(64,462)) })
                timer(3.5,function() {
                    EGP:entity():soundPlay(0,2,"doors/doormove1.wav",1)
                    moveTo(Elements,"Rectangle44",3,vec2(0,-1000))
                    moveTo(Elements,"Rectangle45",3.5,vec2(0,1000))
                    moveTo(Elements,"Ellipse22",2.5,vec2(256,-1000))
                    moveTo(Elements,"START",2.4,vec2(216,-1000))
                })
                # Get player's membership tier
                local PlayerTier = TIER_COPPER  # Default to copper
                if(CurrentPlayer:isValid() && MemberData:exists(CurrentPlayer:steamID())) {
                    PlayerTier = MemberData[CurrentPlayer:steamID(), number]
                }
                
                # Get tier configuration
                local TierR = getTierColorR(PlayerTier)
                local TierG = getTierColorG(PlayerTier)
                local TierB = getTierColorB(PlayerTier)
                local TierTax = getTierTax(PlayerTier) * 100
                local TierInsurance = getTierInsurance(PlayerTier) * 100
                local TierName = getTierName(PlayerTier)
            
                #membershiptier Section (Dynamic based on player's actual tier)
                circle(Elements:get("Ellipse16"), table("x"=152.375, "y"=266.38, "w"=14.375, "h"=9.38, "r"=TierR, "g"=TierG, "b"=TierB))
                circle(Elements:get("Ellipse17"), table("x"=152.375, "y"=444.62, "w"=14.375, "h"=9.38, "r"=TierR, "g"=TierG, "b"=TierB))
                circle(Elements:get("Ellipse18"), table("x"=37.375, "y"=266.38, "w"=14.375, "h"=9.38, "r"=TierR, "g"=TierG, "b"=TierB))
                circle(Elements:get("Ellipse19"), table("x"=37.375, "y"=444.62, "w"=14.375, "h"=9.38, "r"=TierR, "g"=TierG, "b"=TierB))
                box(Elements:get("Rectangle51"), table("x"=-130.0, "y"=257.0, "w"=115.0, "h"=197.0, "r"=42, "g"=42, "b"=42, "radius"=0))
                box(Elements:get("Rectangle53"), table("x"=23.0, "y"=266.3, "w"=144.0, "h"=178.4, "r"=42, "g"=42, "b"=42, "radius"=0))
                
                # Add tier icon matching the membership screen style
                if(PlayerTier == TIER_DIAMOND || PlayerTier == TIER_RUBY) {
                    # Diamond icon
                    box(Elements:get("Rectangle67"), table("x"=38.69, "y"=291.46, "w"=36.97, "h"=29.48, "r"=TierR, "g"=TierG, "b"=TierB, "radius"=0))
                    box(Elements:get("Rectangle68"), table("x"=38.22, "y"=299.24, "w"=37.92, "h"=1.23, "r"=42, "g"=42, "b"=42, "radius"=0))
                    box(Elements:get("Rectangle69"), table("x"=74.18, "y"=289.02, "w"=9.6, "h"=4.31, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle69"), vec2(74.18, 289.02), vec2(0, 0), -57.0)
                    box(Elements:get("Rectangle70"), table("x"=35.01, "y"=297.16, "w"=9.73, "h"=4.31, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle70"), vec2(35.01, 297.16), vec2(0, 0), 57.0)
                    box(Elements:get("Rectangle71"), table("x"=43.54, "y"=291.6, "w"=1.23, "h"=10.56, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle71"), vec2(43.54, 291.6), vec2(0, 0), 37.0)
                    box(Elements:get("Rectangle72"), table("x"=69.97, "y"=290.9, "w"=1.23, "h"=10.56, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle72"), vec2(69.97, 290.9), vec2(0, 0), -37.0)
                    box(Elements:get("Rectangle74"), table("x"=56.42, "y"=290.71, "w"=1.23, "h"=10.56, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle74"), vec2(56.42, 290.71), vec2(0, 0), -37.0)
                    box(Elements:get("Rectangle75"), table("x"=63.16, "y"=299.9, "w"=1.23, "h"=22.39, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle75"), vec2(63.16, 299.9), vec2(0, 0), -16.0)
                    box(Elements:get("Rectangle77"), table("x"=76.71, "y"=298.97, "w"=13.41, "h"=29.52, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle77"), vec2(76.71, 298.97), vec2(0, 0), -40.0)
                    box(Elements:get("Rectangle78"), table("x"=28.0, "y"=308.63, "w"=13.58, "h"=29.52, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle78"), vec2(28.0, 308.63), vec2(0, 0), 40.0)
                    box(Elements:get("Rectangle76"), table("x"=49.88, "y"=300.34, "w"=1.23, "h"=22.39, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle76"), vec2(49.88, 300.34), vec2(0, 0), 16.0)
                    box(Elements:get("Rectangle73"), table("x"=56.89, "y"=291.64, "w"=1.23, "h"=10.56, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle73"), vec2(56.89, 291.64), vec2(0, 0), 37.0)
                } 
                else {
                    # Printer/rack icon for other tiers
                    box(Elements:get("Rectangle60"), table("x"=70.58, "y"=306.86, "w"=21.74, "h"=6.21, "r"=TierR, "g"=TierG, "b"=TierB, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle60"), vec2(70.58, 306.86), vec2(0, 0), 29.0)
                    box(Elements:get("Rectangle62"), table("x"=69.82, "y"=307.07, "w"=12.03, "h"=6.75, "r"=TierR, "g"=TierG, "b"=TierB, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle62"), vec2(69.82, 307.07), vec2(0, 0), -29.0)
                    box(Elements:get("Rectangle64"), table("x"=74.42, "y"=312.72, "w"=21.26, "h"=7.0, "r"=TierR, "g"=TierG, "b"=TierB, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle64"), vec2(74.42, 312.72), vec2(0, 0), 30.0)
                    box(Elements:get("Rectangle65"), table("x"=70.7, "y"=305.96, "w"=8.67, "h"=1.14, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle65"), vec2(70.7, 305.96), vec2(0, 0), -115.0)
                    box(Elements:get("Rectangle61"), table("x"=69.8, "y"=306.26, "w"=8.67, "h"=1.14, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle61"), vec2(69.8, 306.26), vec2(0, 0), -27.0)
                    box(Elements:get("Rectangle63"), table("x"=76.92, "y"=310.41, "w"=1.06, "h"=8.92, "r"=42, "g"=42, "b"=42, "radius"=0))
                    box(Elements:get("Rectangle66"), table("x"=86.91, "y"=294.0, "w"=8.67, "h"=5.04, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("Rectangle66"), vec2(86.91, 294.0), vec2(0, 0), -22.0)
                    box(Elements:get("1" + "Rectangle65"), table("x"=77.14, "y"=310.26, "w"=18.58, "h"=1.14, "r"=42, "g"=42, "b"=42, "radius"=0))
                    EGP:egpAngle(Elements:get("1" + "Rectangle65"), vec2(77.14, 310.26), vec2(0, 0), 29.0)
                }
                
                text(Elements:get("DEFAULT"), table("text"=TierName, "x"=23.0, "y"=266.0, "w"= 144.0, "h"=27.0, "r"=TierR, "g"=TierG, "b"=TierB, "size"=19, "halign"=1, "valign"=1))
                text(Elements:get("35%INSURA"), table("text"="TAX: " + TierTax + "% INSURANCE: " + TierInsurance + "%", "x"=37.94, "y"=296.74, "w"= 114.11, "h"=82.01, "r"=255, "g"=255, "b"=255, "size"=14, "halign"=1, "valign"=1))
                
                # Update bottom text based on tier
                local BottomText = "FIND MEMBERSHIP SCREEN TO UPGRADE"
                if(PlayerTier == TIER_DIAMOND) {
                    BottomText = "YOU HAVE MAX TIER MEMBERSHIP!"
                }
                elseif(PlayerTier != TIER_COPPER) {
                    BottomText = "YOUR CURRENT MEMBERSHIP TIER"
                }
                text(Elements:get("FINDMEMBERSHIP"), table("text"=BottomText, "x"=23.0, "y"=371.0, "w"= 144.0, "h"=67.0, "r"=255, "g"=255, "b"=255, "size"=16, "halign"=1, "valign"=1))
                
                # Parent membership card elements to Rectangle51
                EGP:egpParent(Elements:get("Ellipse16"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("Ellipse16"), vec2(115.005, 9.38)) # 152.375-37.37, 266.38-257.0
                
                EGP:egpParent(Elements:get("Ellipse17"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("Ellipse17"), vec2(115.005, 187.62)) # 152.375-37.37, 444.62-257.0
                
                EGP:egpParent(Elements:get("Ellipse18"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("Ellipse18"), vec2(0.005, 9.38)) # 37.375-37.37, 266.38-257.0
                
                EGP:egpParent(Elements:get("Ellipse19"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("Ellipse19"), vec2(0.005, 187.62)) # 37.375-37.37, 444.62-257.0
                
                EGP:egpParent(Elements:get("Rectangle53"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("Rectangle53"), vec2(-14.37, 9.3)) # 23.0-37.37, 266.3-257.0
                
                # Parent tier icon elements (diamond or printer)
                if(PlayerTier == TIER_DIAMOND || PlayerTier == TIER_RUBY) {
                    EGP:egpParent(Elements:get("Rectangle67"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle67"), vec2(1.32, 34.46)) # 38.69-37.37, 291.46-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle68"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle68"), vec2(0.85, 42.24)) # 38.22-37.37, 299.24-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle69"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle69"), vec2(36.81, 32.02)) # 74.18-37.37, 289.02-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle70"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle70"), vec2(-2.36, 40.16)) # 35.01-37.37, 297.16-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle71"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle71"), vec2(6.17, 34.6)) # 43.54-37.37, 291.6-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle72"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle72"), vec2(32.6, 33.9)) # 69.97-37.37, 290.9-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle74"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle74"), vec2(19.05, 33.71)) # 56.42-37.37, 290.71-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle75"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle75"), vec2(25.79, 42.9)) # 63.16-37.37, 299.9-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle77"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle77"), vec2(39.34, 41.97)) # 76.71-37.37, 298.97-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle78"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle78"), vec2(-9.37, 51.63)) # 28.0-37.37, 308.63-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle76"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle76"), vec2(12.51, 43.34)) # 49.88-37.37, 300.34-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle73"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle73"), vec2(19.52, 34.64)) # 56.89-37.37, 291.64-257.0
                }
                else {
                    EGP:egpParent(Elements:get("Rectangle60"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle60"), vec2(33.21, 49.86)) # 70.58-37.37, 306.86-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle62"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle62"), vec2(32.45, 50.07)) # 69.82-37.37, 307.07-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle64"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle64"), vec2(37.05, 55.72)) # 74.42-37.37, 312.72-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle65"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle65"), vec2(33.33, 48.96)) # 70.7-37.37, 305.96-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle61"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle61"), vec2(32.43, 49.26)) # 69.8-37.37, 306.26-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle63"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle63"), vec2(39.55, 53.41)) # 76.92-37.37, 310.41-257.0
                    
                    EGP:egpParent(Elements:get("Rectangle66"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("Rectangle66"), vec2(49.54, 37.0)) # 86.91-37.37, 294.0-257.0
                    
                    EGP:egpParent(Elements:get("1" + "Rectangle65"), Elements:get("Rectangle51"))
                    EGP:egpPos(Elements:get("1" + "Rectangle65"), vec2(39.77, 53.26)) # 77.14-37.37, 310.26-257.0
                }
                
                # Parent text elements
                EGP:egpParent(Elements:get("DEFAULT"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("DEFAULT"), vec2(-14.37, 9.0)) # 23.0-37.37, 266.0-257.0
                
                EGP:egpParent(Elements:get("35%INSURA"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("35%INSURA"), vec2(0.57, 39.74)) # 37.94-37.37, 296.74-257.0
                
                EGP:egpParent(Elements:get("FINDMEMBERSHIP"), Elements:get("Rectangle51"))
                EGP:egpPos(Elements:get("FINDMEMBERSHIP"), vec2(-14.37, 114.0)) # 23.0-37.37, 371.0-257.0
                timer(5,function() { moveTo(Elements,"Rectangle51",0.5,vec2(37.37,257)) })
            }
        break,
        case "ButtonDepo",
            EGP:entity():soundPlay(0,2,"tau/notifications/5.mp3")
            instructionsScreen(Elements,EGP) 
        break,
        case "InstructionsExitButton",
            Door["Fade", number] = 1
            owner():msg("{!yellow [" + BankName + "] } Player is depositing Printers.")
            Door:entity():soundPlay(0,2,"czero/doorstop1.wav")
            depoActive(Elements, EGP, "default")
            moveTo(Elements, "Rectangle44", 1, vec2(106,277))
            timer(2,0,function() {
                moveTo(Elements, "Rectangle44", 0.8, vec2(56,277))
                timer(1,function() {
                    moveTo(Elements, "Rectangle44", 0.8, vec2(106,277))
                })
            })
        break,
        case "ExitButton",
            screenReset()
            Active = 0
        break,
    }
}

event remote(Sender:entity, Player:entity, Payload:table) {    
    if (Player == owner()) {
        if(Sender == findE2ByName("Cozzah's Banker E2 Membership",200)) {
            MemberData = Payload
            print("{orange " + Sender:getName() + "} table has been loaded with {yellow " + Payload:count() + "} entries.")
        }
    }
}

